<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Catalyst Agent Orchestrator - Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    .header {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 {
      color: #667eea;
      font-size: 2em;
      margin-bottom: 5px;
    }
    .header .controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .header p {
      color: #666;
      font-size: 0.9em;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      text-align: center;
      transition: transform 0.2s;
    }
    .stat-card:hover {
      transform: translateY(-2px);
    }
    .stat-card h3 {
      font-size: 0.9em;
      color: #666;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .stat-card .value {
      font-size: 2em;
      font-weight: bold;
      color: #667eea;
    }
    .stat-card.success .value {
      color: #10b981;
    }
    .stat-card.money .value {
      color: #f59e0b;
    }
    .grid-2col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    @media (max-width: 768px) {
      .grid-2col {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .card h2 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 1.3em;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card h2 .controls {
      display: flex;
      gap: 10px;
      font-size: 0.9em;
    }
    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    .search-box input,
    .search-box select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    .search-box input {
      flex: 1;
    }
    .search-box input:focus,
    .search-box select:focus {
      outline: none;
      border-color: #667eea;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      text-align: left;
      padding: 12px;
      border-bottom: 1px solid #eee;
    }
    th {
      background: #f8f9fa;
      color: #666;
      font-weight: 600;
      font-size: 0.9em;
      cursor: pointer;
    }
    th:hover {
      background: #e9ecef;
    }
    tr:hover {
      background: #f8f9fa;
    }
    .status-success {
      color: #10b981;
      font-weight: 500;
    }
    .status-error {
      color: #ef4444;
      font-weight: 500;
    }
    .status-clickable {
      cursor: pointer;
      text-decoration: underline;
    }
    .status-clickable:hover {
      opacity: 0.7;
    }
    #req-error-row {
      display: none;
    }
    #req-error-row.has-error {
      display: flex;
    }
      color: #ef4444;
      font-weight: 500;
    }
    .agent-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #e0e7ff;
      color: #667eea;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .agent-tag:hover {
      background: #c7d2fe;
      transform: scale(1.05);
    }
    .status-badge {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 4px;
      cursor: default;
    }
    .status-badge.online {
      background: #10b981;
      box-shadow: 0 0 6px rgba(16, 185, 129, 0.3);
    }
    .status-badge.offline {
      background: #ef4444;
      box-shadow: 0 0 6px rgba(239, 68, 68, 0.3);
    }
    .status-badge.small {
      width: 8px;
      height: 8px;
      margin-right: 4px;
    }
    .running-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .running-indicator .status-text {
      font-size: 0.85em;
      color: #666;
    }
    .bar {
      background: #e0e7ff;
      border-radius: 4px;
      overflow: hidden;
      margin: 8px 0;
      position: relative;
    }
    .bar:hover {
      background: #c7d2fe;
    }
    .bar-fill {
      background: linear-gradient(90deg, #667eea, #764ba2);
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 12px;
      color: white;
      font-size: 0.85em;
      font-weight: 500;
      transition: width 0.3s;
    }
    .chart-container {
      height: 250px;
      margin-top: 20px;
    }
    .log-filters {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .filter-btn {
      padding: 6px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.2s;
    }
    .filter-btn:hover {
      background: #f8f9fa;
    }
    .filter-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    .refresh-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background 0.2s;
    }
    .refresh-btn:hover {
      background: #5568d3;
    }
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
    }
    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: white;
      border-radius: 16px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalSlideIn 0.3s ease-out;
    }
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px;
      border-bottom: 1px solid #eee;
    }
    .modal-header h3 {
      color: #667eea;
      margin: 0;
      font-size: 1.5em;
    }
    .modal-close {
      background: #f8f9fa;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      color: #666;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-close:hover {
      background: #e9ecef;
      color: #ef4444;
      transform: rotate(90deg);
    }
    .modal-body {
      padding: 24px;
    }
    .modal-section {
      margin-bottom: 20px;
    }
    .modal-section h4 {
      color: #666;
      margin: 0 0 12px 0;
      font-size: 1em;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    .info-label {
      color: #666;
      font-size: 0.9em;
    }
    .info-value {
      font-weight: 500;
      color: #333;
    }
    .status-badge {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-badge.online {
      background: #10b981;
    }
    .status-badge.offline {
      background: #ef4444;
    }
    .services-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .service-item {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #e9ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .service-item:hover {
      background: #f0f0f0;
    }
    .service-item strong {
      color: #667eea;
    }
    .service-item .price {
      font-weight: 500;
      color: #333;
      background: white;
      padding: 2px 8px;
      border-radius: 4px;
    }
    .description {
      color: #666;
      font-size: 0.9em;
      line-height: 1.5;
      background: #f8f9fa;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    /* Error log viewer */
    .error-logs {
      max-height: 300px;
      overflow-y: auto;
      background: #fff5f5;
      border: 1px solid #fed7aa;
      border-radius: 6px;
      padding: 15px;
      margin-top: 15px;
    }
    .error-logs .error-log-item {
      background: white;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 4px;
      border-left: 3px solid #ef4444;
    }
    .error-logs .error-log-item .error-time {
      font-size: 0.85em;
      color: #666;
      margin-bottom: 4px;
    }
    .error-logs .error-log-item .error-message {
      color: #dc2626;
      font-family: monospace;
      font-size: 0.9em;
    }
    .error-logs .error-log-item .error-details {
      margin-top: 6px;
      font-size: 0.85em;
      color: #999;
    }
    /* Charts */
    .chart-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    .chart-card {
      background: white;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .chart-card h3 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 1.1em;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>üöÄ Catalyst Agent Orchestrator</h1>
        <p>Multi-agent orchestration dashboard</p>
      </div>
      <div class="controls">
        <button class="refresh-btn" onclick="refreshDashboard()">üîÑ Refresh</button>
        <span id="uptime" style="color: #666; font-size: 0.9em;">Uptime: -</span>
      </div>
    </div>

    <div class="stats-grid" id="stats">
      <div class="stat-card">
        <h3>Total Requests</h3>
        <div class="value" id="total-requests">-</div>
      </div>
      <div class="stat-card success">
        <h3>Success Rate</h3>
        <div class="value" id="success-rate">-</div>
      </div>
      <div class="stat-card money">
        <h3>Total Earnings</h3>
        <div class="value" id="total-earnings">$-</div>
      </div>
      <div class="stat-card">
        <h3>Avg Response Time</h3>
        <div class="value" id="avg-time">-ms</div>
      </div>
    </div>

    <div class="grid-2col">
      <div class="card">
        <h2>
          üìä Recent Requests
          <span class="controls">
            <span class="search-box">
              <input type="text" id="log-search" placeholder="Search logs..." onkeyup="filterLogs()">
              <select id="log-filter" onchange="filterLogs()">
                <option value="all">All</option>
                <option value="success">Success</option>
                <option value="error">Error</option>
              </select>
            </span>
          </span>
        </h2>
        <div class="log-filters">
          <button class="filter-btn active" onclick="setTimeFilter('all')" data-filter="all">All</button>
          <button class="filter-btn" onclick="setTimeFilter('hour')" data-filter="hour">Last Hour</button>
          <button class="filter-btn" onclick="setTimeFilter('day')" data-filter="day">Last 24h</button>
          <button class="filter-btn" onclick="setTimeFilter('week')" data-filter="week">Last 7 Days</button>
        </div>
        <div id="requests-table">
          <div class="loading">Loading...</div>
        </div>
      </div>

    <!-- Request Details Modal -->
    <div class="modal" id="request-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Request Details</h3>
          <button class="modal-close" onclick="closeRequestModal()">√ó</button>
        </div>
        <div class="modal-body">
          <div class="modal-section">
            <h4>Basic Information</h4>
            <div class="info-row">
              <span class="info-label">Timestamp:</span>
              <span class="info-value" id="req-timestamp">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Status:</span>
              <span class="info-value" id="req-status">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Execution Time:</span>
              <span class="info-value" id="req-time">-</span>
            </div>
          </div>
          <div class="modal-section">
            <h4>Request</h4>
            <div class="info-row">
              <span class="info-label">Goal:</span>
              <span class="info-value" id="req-goal" style="word-break: break-word;">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Category:</span>
              <span class="info-value" id="req-category">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Max Price:</span>
              <span class="info-value" id="req-max-price">-</span>
            </div>
          </div>
          <div class="modal-section">
            <h4>Results</h4>
            <div class="info-row">
              <span class="info-label">Total Cost:</span>
              <span class="info-value" id="req-cost">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Agents Used:</span>
              <span class="info-value" id="req-agents">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Result Summary:</span>
              <span class="info-value" id="req-summary" style="font-size: 0.9em; max-height: 200px; overflow-y: auto;">-</span>
            </div>
            <div class="info-row" id="req-error-row">
              <span class="info-label">Error:</span>
              <span class="info-value" id="req-error">-</span>
            </div>
          </div>
        </div>
      </div>
    </div>
      <div class="card">
        <h2>üìà Agents</h2>
        <div id="agent-usage">
          <div class="loading">Loading...</div>
        </div>
        <div class="chart-container">
          <canvas id="agent-chart"></canvas>
        </div>
      </div>
    </div>

    <div class="grid-2col">
      <div class="card">
        <h2>üè∑Ô∏è Category Distribution</h2>
        <div id="category-stats">
          <div class="loading">Loading...</div>
        </div>
      </div>
      <div class="card">
        <h2>üí∞ Revenue Timeline</h2>
        <div class="chart-container">
          <canvas id="revenue-chart"></canvas>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>‚ùå Error Logs</h2>
      <div class="error-logs" id="error-logs">
        <div class="empty-state">No errors found</div>
      </div>
    </div>
  </div>

  <!-- Agent Details Modal -->
  <div class="modal" id="agent-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-agent-name">Agent Details</h3>
        <button class="modal-close" onclick="closeAgentModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="modal-section">
          <h4>Basic Information</h4>
          <div class="info-row">
            <span class="info-label">Agent ID:</span>
            <span class="info-value" id="modal-agent-id">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">Name:</span>
            <span class="info-value" id="modal-agent-name-display">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">Wallet:</span>
            <span class="info-value" id="modal-wallet">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">Status:</span>
            <span class="info-value"><span class="status-badge" id="modal-status"></span></span>
          </div>
        </div>
        <div class="modal-section">
          <h4>Performance Metrics</h4>
          <div class="info-row">
            <span class="info-label">Success Rate:</span>
            <span class="info-value" id="modal-success-rate">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">Total Calls:</span>
            <span class="info-value" id="modal-total-calls">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">Last Active:</span>
            <span class="info-value" id="modal-last-active">-</span>
          </div>
        </div>
        <div class="modal-section">
          <h4>Description</h4>
          <div class="description" id="modal-description">-</div>
        </div>
        <div class="modal-section" id="modal-services-section">
          <h4>Services (<span id="modal-services-count">0</span>)</h4>
          <div class="services-list" id="modal-services-list">
            <!-- Services will be dynamically added here -->
          </div>
        </div>
        <div class="modal-section" id="modal-twitter-section">
          <h4>Social</h4>
          <div class="info-row">
            <span class="info-label">Twitter:</span>
            <span class="info-value" id="modal-twitter">-</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // State
    let currentLogs = [];
    let currentTimeFilter = 'all';
    let currentStatusFilter = 'all';
    let revenueChart = null;
    let agentChart = null;
    let selectedLog = null;

    // Fetch data
    async function fetchStats() {
      try {
        const response = await fetch('/api/stats');
        return await response.json();
      } catch (error) {
        console.error('Failed to fetch stats:', error);
        return null;
      }
    }

    async function fetchLogs() {
      try {
        const response = await fetch('/api/logs?limit=200');
        return await response.json();
      } catch (error) {
        console.error('Failed to fetch logs:', error);
        return null;
      }
    }

    function formatTime(date) {
      return new Date(date).toLocaleTimeString();
    }

    function formatDate(date) {
      return new Date(date).toLocaleString();
    }

    // Format agent ID with click handler
    function formatAgentTag(agentId) {
      const agent = getAgentDetailsFromCache(agentId);
      const statusHtml = agent ? `
        <span class="status-badge ${agent.metrics.is_online ? 'online' : 'offline'}"></span>
      ` : '';
      
      return `<span class="agent-tag" onclick="openAgentModal('${agentId}')">
        ${statusHtml}${agentId}
      </span>`;
    }

    // Open agent modal
    function openAgentModal(agentId) {
      const agent = getAgentDetailsFromCache(agentId);
      
      if (!agent) {
        alert('Agent details not found in cache. Try refreshing the dashboard.');
        return;
      }

      // Update modal content
      document.getElementById('modal-agent-name').textContent = agent.name;
      document.getElementById('modal-agent-id').textContent = agent.id;
      document.getElementById('modal-agent-name-display').textContent = agent.name;
      document.getElementById('modal-wallet').textContent = agent.wallet_address;
      
      // Status
      const statusHtml = `
        <span class="status-badge ${agent.metrics.is_online ? 'online' : 'offline'}"></span>
      `;
      document.getElementById('modal-status').innerHTML = statusHtml;
      
      // Metrics
      document.getElementById('modal-success-rate').textContent = (agent.metrics.success_rate * 100).toFixed(1) + '%';
      document.getElementById('modal-total-calls').textContent = agent.metrics.successful_job_count.toLocaleString();
      document.getElementById('modal-last-active').textContent = formatDate(agent.metrics.last_active_at);
      
      // Description
      document.getElementById('modal-description').textContent = agent.description || 'No description available';
      
      // Services
      const servicesList = document.getElementById('modal-services-list');
      document.getElementById('modal-services-count').textContent = agent.job_offerings.length;
      
      if (agent.job_offerings.length === 0) {
        servicesList.innerHTML = '<div style="color: #999;">No services available</div>';
      } else {
        servicesList.innerHTML = agent.job_offerings.map(s => `
          <div class="service-item">
            <strong>${s.name}</strong>
            <span class="price">$${s.price.toFixed(2)}</span>
          </div>
        `).join('');
      }
      
      // Twitter
      const twitterSection = document.getElementById('modal-twitter-section');
      if (agent.twitter_handle) {
        twitterSection.style.display = 'block';
        document.getElementById('modal-twitter').textContent = '@' + agent.twitter_handle;
      } else {
        twitterSection.style.display = 'none';
      }

      // Show modal
      document.getElementById('agent-modal').classList.add('show');
    }

    // Close agent modal
    function closeAgentModal() {
      document.getElementById('agent-modal').classList.remove('show');
    }

    // Open request details modal
    function openRequestModal(logIndex) {
      const log = currentLogs[logIndex];
      if (!log) return;

      selectedLog = log;

      // Update modal content
      document.getElementById('req-timestamp').textContent = formatDate(log.timestamp);
      document.getElementById('req-status').innerHTML = `<span class="status-${log.status}">${log.status.toUpperCase()}</span>`;
      document.getElementById('req-time').textContent = `${log.execution_time_ms}ms`;
      document.getElementById('req-goal').textContent = log.goal;
      document.getElementById('req-category').textContent = log.category;
      document.getElementById('req-max-price').textContent = `$${(log.max_price || 0).toFixed(3)}`;
      document.getElementById('req-cost').textContent = `$${log.cost.toFixed(3)}`;
      document.getElementById('req-agents').textContent = log.agents_used.length > 0
        ? log.agents_used.map(a => formatAgentTag(a)).join(' ')
        : 'None';
      document.getElementById('req-summary').textContent = log.result_summary || 'No summary';

      // Show error row if error
      const errorRow = document.getElementById('req-error-row');
      if (log.error) {
        errorRow.classList.add('has-error');
        document.getElementById('req-error').textContent = log.error;
      } else {
        errorRow.classList.remove('has-error');
        document.getElementById('req-error').textContent = '-';
      }

      // Show modal
      document.getElementById('request-modal').classList.add('show');
    }

    // Close request modal
    function closeRequestModal() {
      document.getElementById('request-modal').classList.remove('show');
      selectedLog = null;
    }

    // Get agent details from cache (mock for now, could be fetched from API)
    function getAgentDetailsFromCache(agentId) {
      // This is a mock - you could implement a real endpoint
      const agents = {
        '84': { name: 'Ethy AI', wallet_address: '0xfc9f1fF5eC524759c1Dc8E0a6EBA6c22805b9d8B', metrics: { success_rate: 0.996, is_online: true, successful_job_count: 1128712, last_active_at: new Date().toISOString() }, job_offerings: [{ name: 'yield_analysis', price: 0.5 }, { name: 'swap', price: 0.5 }], twitter_handle: 'ethy_agent' },
        '565': { name: 'Otto AI', wallet_address: '0xe5B38F112b92Ce8F2103eDAbA7E9a9842f12d5f6', metrics: { success_rate: 0.9657, is_online: true, successful_job_count: 12489, last_active_at: new Date().toISOString() }, job_offerings: [{ name: 'twitter_alpha', price: 0.01 }, { name: 'crypto_news', price: 0.05 }, { name: 'topic_research', price: 1 }, { name: 'kol_alpha', price: 0.25 }, { name: 'yield_alpha', price: 0.5 }], twitter_handle: 'useOttoAI' },
      };
      return agents[agentId] || null;
    }

    // Time filter
    function setTimeFilter(filter) {
      currentTimeFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === filter) {
          btn.classList.add('active');
        }
      });
      renderLogs();
    }

    // Status filter
    function filterLogs() {
      currentStatusFilter = document.getElementById('log-filter').value;
      const searchTerm = document.getElementById('log-search').value.toLowerCase();
      renderLogs();
    }

    // Filter logs
    function getFilteredLogs() {
      return currentLogs.filter(log => {
        // Status filter
        if (currentStatusFilter !== 'all' && log.status !== currentStatusFilter) {
          return false;
        }

        // Time filter
        if (currentTimeFilter !== 'all') {
          const logTime = new Date(log.timestamp);
          const now = new Date();
          const hoursAgo = (now - logTime) / (1000 * 60 * 60);

          if (currentTimeFilter === 'hour' && hoursAgo > 1) return false;
          if (currentTimeFilter === 'day' && hoursAgo > 24) return false;
          if (currentTimeFilter === 'week' && hoursAgo > 7 * 24) return false;
        }

        // Search filter
        const searchTerm = document.getElementById('log-search').value.toLowerCase();
        if (searchTerm && !log.goal.toLowerCase().includes(searchTerm)) {
          return false;
        }

        return true;
      });
    }

    // Render stats
    function renderStats(stats) {
      if (!stats) return;

      document.getElementById('total-requests').textContent = stats.summary.total_requests;
      document.getElementById('success-rate').textContent = stats.summary.success_rate + '%';
      document.getElementById('total-earnings').textContent = '$' + stats.summary.total_earnings;
      document.getElementById('avg-time').textContent = stats.summary.avg_execution_time_ms + 'ms';
      document.getElementById('uptime').textContent = 'Uptime: ' + Math.floor(stats.summary.uptime / 60) + 'm';
    }

    // Render logs
    function renderLogs() {
      const filteredLogs = getFilteredLogs();

      if (filteredLogs.length === 0) {
        document.getElementById('requests-table').innerHTML = '<div class="empty-state">No logs match your filters</div>';
        return;
      }

      const rows = filteredLogs.map((log, index) => `
        <tr>
          <td>${formatTime(log.timestamp)}</td>
          <td>${log.goal.substring(0, 50)}${log.goal.length > 50 ? '...' : ''}</td>
          <td>${log.agents_used.map(a => formatAgentTag(a)).join('')}</td>
          <td>$${log.cost.toFixed(3)}</td>
          <td>${log.execution_time_ms}ms</td>
          <td><span class="status-${log.status} status-clickable" onclick="openRequestModal(${index})">${log.status.toUpperCase()}</span></td>
        </tr>
      `).join('');

      document.getElementById('requests-table').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>Goal</th>
              <th>Agents</th>
              <th>Cost</th>
              <th>Time</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;
    }

    // Render agent usage
    function renderAgentUsage(stats) {
      if (!stats || !stats.agents || stats.agents.length === 0) {
        document.getElementById('agent-usage').innerHTML = '<div class="empty-state">No calls yet</div>';
        return;
      }

      const maxCount = Math.max(...stats.agent_usage.map(a => a.count));
      const bars = stats.agent_usage.map(item => {
        const agent = getAgentDetailsFromCache(item.agent);
        const statusHtml = agent ? `
          <span class="status-badge ${agent.metrics.is_online ? 'online' : 'offline'}"></span>
        ` : '';
        return `
          <div class="bar" style="cursor: pointer;" onclick="openAgentModal('${item.agent}')">
            <div class="bar-fill" style="width: ${(item.count / maxCount) * 100}%">
              ${statusHtml}<span>${item.agent}</span>
              <span>${item.count} calls</span>
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('agent-usage').innerHTML = bars;

      // Render chart
      if (agentChart) agentChart.destroy();
      agentChart = new Chart(document.getElementById('agent-chart'), {
        type: 'bar',
        data: {
          labels: stats.agent_usage.map(a => a.agent),
          datasets: [{
            label: 'Calls',
            data: stats.agent_usage.map(a => a.count),
            backgroundColor: [
              'rgba(102, 126, 234, 0.8)',
              'rgba(118, 75, 162, 0.8)',
              'rgba(16, 185, 129, 0.8)',
              'rgba(239, 68, 68, 0.8)',
              'rgba(107, 114, 128, 0.8)',
              'rgba(245, 158, 11, 0.8)',
              'rgba(254, 202, 87, 0.8)'
            ],
            borderColor: [
              'rgb(102, 126, 234)',
              'rgb(118, 75, 162)',
              'rgb(16, 185, 129)',
              'rgb(239, 68, 68)',
              'rgb(107, 114, 128)',
              'rgb(245, 158, 11)',
              'rgb(254, 202, 87)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    }

    // Render category stats
    function renderCategoryStats(stats) {
      if (!stats || !stats.category_stats || stats.category_stats.length === 0) {
        document.getElementById('category-stats').innerHTML = '<div class="empty-state">No data yet</div>';
        return;
      }

      const maxCount = Math.max(...stats.category_stats.map(c => c.request_count));
      const bars = stats.category_stats.map(item => `
        <div class="bar">
          <div class="bar-fill" style="width: ${(item.request_count / maxCount) * 100}%">
            <span>${item.category}</span>
            <span>${item.request_count} requests</span>
          </div>
        </div>
      `).join('');

      document.getElementById('category-stats').innerHTML = bars;
    }

    // Render error logs
    function renderErrorLogs(logs) {
      const errorLogs = logs.filter(l => l.status === 'error');
      
      if (errorLogs.length === 0) {
        document.getElementById('error-logs').innerHTML = '<div class="empty-state">No errors found</div>';
        return;
      }

      const errorItems = errorLogs.map(log => `
        <div class="error-log-item">
          <div class="error-time">${formatDate(log.timestamp)}</div>
          <div class="error-message">${log.error}</div>
          <div class="error-details">
            Goal: ${log.goal.substring(0, 50)}...<br>
            Category: ${log.category}
          </div>
        </div>
      `).join('');

      document.getElementById('error-logs').innerHTML = errorItems;
    }

    // Render revenue chart
    function renderRevenueChart(logs) {
      const canvas = document.getElementById('revenue-chart');
      if (!canvas || !logs || logs.length === 0) {
        canvas.style.display = 'none';
        canvas.parentElement.innerHTML = '<div class="empty-state">No revenue data yet</div>';
        return;
      }
      canvas.style.display = 'block';
      canvas.parentElement.innerHTML = '<canvas id="revenue-chart"></canvas>';

      // Group revenue by date
      const revenueByDate = {};
      logs.filter(l => l.status === 'success').forEach(log => {
        const date = new Date(log.timestamp).toLocaleDateString();
        revenueByDate[date] = (revenueByDate[date] || 0) + log.cost;
      });

      const dates = Object.keys(revenueByDate);
      const revenues = Object.values(revenueByDate);
      const cumulativeRevenues = [];
      let total = 0;
      revenues.forEach(r => {
        total += r;
        cumulativeRevenues.push(total);
      });

      if (revenueChart) revenueChart.destroy();
      revenueChart = new Chart(canvas, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: 'Cumulative Earnings',
            data: cumulativeRevenues,
            borderColor: 'rgb(245, 158, 11)',
            backgroundColor: 'rgba(245, 158, 11, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    // Refresh dashboard
    async function refreshDashboard() {
      const [stats, logs] = await Promise.all([fetchStats(), fetchLogs()]);
      
      if (stats) renderStats(stats);
      if (logs) {
        currentLogs = logs.logs || [];
        renderLogs();
        renderErrorLogs(logs.logs || []);
        renderRevenueChart(logs.logs || []);
      }
      if (stats) renderAgentUsage(stats);
      if (stats) renderCategoryStats(stats);
    }

    // Close modal on backdrop click
    document.getElementById('agent-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeAgentModal();
      }
    });

    document.getElementById('request-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeRequestModal();
      }
    });

    // Close modal on ESC key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeAgentModal();
        closeRequestModal();
      }
    });

    // Initial load
    refreshDashboard();

    // Auto-refresh every 10 seconds
    setInterval(refreshDashboard, 10000);
  </script>
</body>
</html>
